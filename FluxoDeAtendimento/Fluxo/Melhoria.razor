@page "/melhoria"
@inject FluxoDeAtendimento.Repositories.ContatoRepository ContatoRepo
@inject NavigationManager NavManager


<h3 class="text-2xl font-bold mb-2">Fluxo - Sugestão de Melhoria </h3>

@if (contato is null)
{
    <p>Nenhum contato identificado. Necessário informar os dados do contato antes de prosseguir para registrar.<a href="/identificacao"> Clique aqui</a> para começar novamente.</p>
}
else
{
    <div class="bg-gray-50 p-4 rounded border mb-4" style="max-width:600px;">
        <p><strong>Nome:</strong> @contato.Nome</p>
        <p><strong>Usuário:</strong> @contato.Usuario</p>
        <p><strong>Administrador:</strong> @contato.Administrador</p>
        <p><strong>Situação:</strong> @contato.Situacao</p>
        <p><strong>• Sugestão de Melhoria</strong></p>
    </div>


    <!-- Campo de Sugestão de melhoria -->
    <div class="bg-gray-100 p-4 rounded border mb-4" style="max-width:600px;">
        <label for="sugestao" class="font-semibold block mb-2">Digite sua sugestão de melhoria:</label>
        <textarea id="sugestao"
                  class="w-full border rounded p-2 block resize-both overflow-auto align-top"
                  rows="4"
                  placeholder="Digite aqui a sugestão de melhoria..."
                  @bind="sugestao">
            </textarea>
    </div>

    <!-- Orientação ao atendente -->
    <div class="bg-blue-50 p-4 rounded border border-blue-300 mb-4">
        <h4 class="font-semibold text-blue-700 mb-2">📘 Orientação ao atendente</h4>
        <p>
            Em casos de sugestão de melhoria, será necessário criar uma tarefa de melhoria no Kanban do desenvolvimento. Primeiro solicite ao cliente mais detalhes sobre a melhoria.<br>
            <br>

            <h4 class="font-semibold text-blue-700 mb-2">💬 Sugestão de mensagem ao cliente:</h4>
            <br>

            Agradecemos por compartilhar sua sugestão de melhoria conosco! Para que possamos analisar e implementar da melhor forma possível, poderia nos fornecer alguns detalhes adicionais?<br>

            Qual é exatamente a melhoria que você gostaria de ver?<br>

            Como você espera que essa mudança funcione na prática?<br>

            Há algum impacto específico que você espera que essa melhoria tenha em seu dia a dia ou no uso do sistema?<br>

            Quanto mais informações você puder nos fornecer, melhor conseguiremos atender à sua sugestão.<br>

        </p>
    </div>


    <!-- Botões -->
    <div style="display:flex; flex-direction:column; gap:10px; width:200px; margin-top:10px;">
        <button class="btn btn-primary w-full" @onclick="VoltarSuporte">Voltar para Suporte</button>
        <button class="btn btn-primary w-full" @onclick="FinalizarAtMelhoria">Finalizar</button>
    </div>

}

@code {
    private FluxoDeAtendimento.Models.Contato? contato;
    private string sugestao = string.Empty;


    protected override void OnInitialized()
    {
        contato = ContatoRepo.ObterContatoAtual();
        ContatoRepo.RegistrarEtapa("Acessou a tela de registro de Melhorias");
    }

    private void VoltarSuporte() => NavManager.NavigateTo("/fluxo/suporte");
    private void FinalizarAtMelhoria()
    {
        if (contato != null && !string.IsNullOrWhiteSpace(sugestao))
        {
            // 1. Atribui o valor da textarea (sugestao) à propriedade SugestaoMelhoria do Contato
            contato.SugestaoMelhoria = sugestao;

            // 2. Registra a etapa com o valor da sugestão.
            ContatoRepo.RegistrarEtapa($"Melhoria registrada: {sugestao}");
        }

        // 3. Navega para a tela de finalização
        NavManager.NavigateTo("/melhoria/finalizacaomelhoria");
    }

}
