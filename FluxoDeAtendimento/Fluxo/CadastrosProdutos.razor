@page "/fluxo/cadastros/produtos"
@inject FluxoDeAtendimento.Repositories.ContatoRepository ContatoRepo
@inject NavigationManager NavManager

<h3 class="text-2xl font-bold mb-2">Fluxo - Cadastros / Produtos</h3>



@if (contato is null)
{
    <p>Nenhum contato identificado. <a href="/identificacao">Clique aqui</a> para começar novamente.</p>
}
else
{
        <div class="bg-gray-50 p-4 rounded border mb-4" style="max-width:600px;">
        <p><strong>Nome:</strong> @contato.Nome</p>
        <p><strong>Usuário:</strong> @contato.Usuario</p>
        <p><strong>Administrador:</strong> @contato.Administrador</p>
        <p><strong>Situação:</strong> @contato.Situacao</p>
        <p><strong>Módulo: Cadastros</strong></p>
        <p><strong>• Cadastros de Produtos</strong></p>
    </div>


    <!-- Orientação ao atendente -->
    <div class="bg-blue-50 p-4 rounded border border-blue-300 mb-4">
        <h4 class="font-semibold text-blue-700 mb-2">📘 Orientação ao atendente</h4>
        <p>
            Verifique se o cliente está com dificuldade para cadastrar ou editar produtos.
            Confirme se há erro exibido, e oriente o cliente a revisar os campos obrigatórios como:
        </p>
        <ul class="list-disc pl-6 mt-2">
            <li>Nome do produto</li>
            <li>NCM e CFOP válidos</li>
            <li>Categoria configurada</li>
        </ul>
    </div>

    <!-- Sugestão de mensagem -->
    <div class="bg-green-50 p-4 rounded border border-green-300 mb-4">
        <h4 class="font-semibold text-green-700 mb-2">💬 Sugestão de mensagem para o cliente</h4>
        <p>
            <i>
                Olá <strong>@contato.Nome</strong>!
                Vi que você está com dificuldade no cadastro de produtos.
                Confira se todos os campos obrigatórios estão preenchidos corretamente — principalmente <strong>NCM</strong>, <strong>CFOP</strong> e <strong>Categoria</strong>.
                Se ainda assim ocorrer erro, envie uma captura de tela para que possamos verificar juntos. 😊
            </i>
        </p>
    </div>

    <!-- Links da Central de Ajuda -->
    <div class="bg-yellow-50 p-4 rounded border border-yellow-300 mb-4">
        <h4 class="font-semibold text-yellow-700 mb-2">🔗 Links da Central de Ajuda</h4>
        <p>Confira os materiais de apoio referentes a <strong>cadastros de produtos</strong>:</p>
        <ul class="list-disc pl-6 mt-2 space-y-1">
            <li>
                <a href="https://ajuda.sigecloud.com.br/como-cadastrar-produtos-no-sige-cloud/"
                   target="_blank"
                   class="text-blue-700 hover:underline">
                    📘 Como cadastrar Produtos no SIGE Cloud
                </a>
            </li>
            <li>
                <a href="https://ajuda.sigecloud.com.br/como-cadastrar-kits-de-produtos-no-sige-cloud/"
                   target="_blank"
                   class="text-blue-700 hover:underline">
                    📦 Como cadastrar Kits de Produtos no SIGE Cloud
                </a>
            </li>
        </ul>
    </div>

    <!-- Campo de Conclusão -->
    <div class="bg-gray-100 p-4 rounded border mb-4" style="max-width:600px;">
        <label for="conclusao" class="font-semibold block mb-2">Conclusão:</label>
        <textarea id="conclusao"
                  class="w-full border rounded p-2 block resize-both overflow-auto align-top"
                  rows="4"
                  placeholder="Digite a conclusão do atendimento..."
                  @bind="conclusao">
        </textarea>

    </div>

    <!-- Botões -->
    <div style="display:flex; flex-direction:column; gap:10px; width:200px; margin-top:10px;">
        <button class="btn btn-primary w-full" @onclick="VoltarCadastros">Voltar para Cadastros</button>
        <button class="btn btn-primary w-full" @onclick="VoltarSuporte">Voltar para Suporte</button>
        <button class="btn btn-primary w-full" @onclick="FinalizarAtendimento">Finalizar Atendimento</button>
    </div>

    <!-- Histórico -->
    <h4 class="mt-6 mb-2 text-lg font-semibold">Histórico de etapas</h4>
    <ul class="list-disc pl-6">
        @foreach (var etapa in ContatoRepo.ObterHistorico())
        {
            <li>@etapa</li>
        }
    </ul>
}

@code {
    private FluxoDeAtendimento.Models.Contato? contato;
    private string conclusao = string.Empty;

    protected override void OnInitialized()
    {
        contato = ContatoRepo.ObterContatoAtual();
        ContatoRepo.DefinirModulo("Cadastros");
        ContatoRepo.DefinirSubEtapa("Produto");

        ContatoRepo.RegistrarEtapa("Acessou a etapa de Produtos");
    }

    private void VoltarCadastros() => NavManager.NavigateTo("/fluxo/cadastros");
    private void VoltarSuporte() => NavManager.NavigateTo("/fluxo/suporte");

    private void FinalizarAtendimento()
    {
        if (!string.IsNullOrWhiteSpace(conclusao))
        {
            ContatoRepo.DefinirConclusao(conclusao);
            ContatoRepo.RegistrarEtapa($"Conclusão: {conclusao}");
        }

        NavManager.NavigateTo("/fluxo/finalizacao");
    }
}