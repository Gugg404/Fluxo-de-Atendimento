@page "/fluxo/estoque/movimentacoes"
@inject FluxoDeAtendimento.Repositories.ContatoRepository ContatoRepo
@inject NavigationManager NavManager

<h3 class="text-2xl font-bold mb-2">Fluxo - Estoque - Movimentações</h3>

<div class="bg-gray-50 p-4 rounded border mb-4" style="max-width:600px;">
    <p><strong>Nome:</strong> @contato.Nome</p>
    <p><strong>Usuário:</strong> @contato.Usuario</p>
    <p><strong>Administrador:</strong> @contato.Administrador</p>
    <p><strong>Situação:</strong> @contato.Situacao</p>
    <p><strong>Módulo: Estoque</strong></p>
    <p><strong>• Movimentações</strong></p>
</div>

<div class="bg-blue-50 p-4 rounded border border-blue-300 mb-4">
    <h4 class="font-semibold text-blue-700 mb-2">📘 Orientação ao atendente</h4>
    <p>
        Verifique se o cliente está com dificuldade para realizar movimentações, caso esteja retornando algum erro em que o produto não conste disponível em estoque, vale verificar:
    </p>
    <ul class="list-disc pl-6 mt-2">
        <li>Se o saldo do produto não está em reserva de estoque</li>
        <li>Se há saldo disponível no estoque para a movimentação desejada</li>
        <li>Se o tipo de movimentação está correto (entrada, saída, transferência)</li>
    </ul>
</div>

<!-- Campo de Conclusão -->
<div class="bg-gray-100 p-4 rounded border mb-4" style="max-width:600px;">
    <label for="conclusao" class="font-semibold block mb-2">Conclusão:</label>
    <textarea id="conclusao"
              class="w-full border rounded p-2 block resize-both overflow-auto align-top"
              rows="4"
              placeholder="Digite a conclusão do atendimento..."
              @bind="conclusao">
    </textarea>
</div>

<div style="display:flex; flex-direction:column; gap:10px; width:200px; margin-top:10px;">
    <button class="btn btn-primary" @onclick="VoltarEstoque">Voltar para Estoque</button>
    <button class="btn btn-primary" @onclick="FinalizarAtendimento">Finalizar Atendimento</button>
</div>

<h4 class="mt-6 mb-2 text-lg font-semibold">Histórico de etapas</h4>
<ul class="list-disc pl-6">
    @foreach (var etapa in ContatoRepo.ObterHistorico())
    {
        <li>@etapa</li>
    }
</ul>

@code {
    private FluxoDeAtendimento.Models.Contato? contato;
    private string conclusao = string.Empty;

    protected override void OnInitialized()
    {
        contato = ContatoRepo.ObterContatoAtual();
        if (contato != null)
        {
            ContatoRepo.DefinirModulo("Estoque");
            ContatoRepo.RegistrarEtapa("Entrou em Estoque - Movimentações");
        }
    }

    private void VoltarEstoque() => NavManager.NavigateTo("/fluxo/estoque");

    private void FinalizarAtendimento()
    {
        if (!string.IsNullOrWhiteSpace(conclusao))
        {
            ContatoRepo.DefinirConclusao(conclusao);
            ContatoRepo.RegistrarEtapa($"Conclusão: {conclusao}");
        }

        NavManager.NavigateTo("/fluxo/finalizacao");
    }
}